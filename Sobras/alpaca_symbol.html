{% extends 'base.html' %}

{% block title %}{{ symbol }} - Datos de Mercado - DAS Trader Analyzer{% endblock %}

{% block header %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-chart-line text-primary mr-2"></i> {{ symbol }}
    </h1>
    <div>
        <a href="{{ url_for('alpaca.alpaca_dashboard') }}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm mr-2">
            <i class="fas fa-arrow-left fa-sm text-white-50"></i> Volver al Dashboard
        </a>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id="createAlertBtn">
            <i class="fas fa-bell fa-sm text-white-50"></i> Crear Alerta
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
{% if not market_data or not market_data.success %}
<div class="alert alert-danger">
    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Error</h4>
    <p>No se pudieron obtener los datos de mercado para {{ symbol }}.</p>
    {% if market_data and market_data.error %}
    <hr>
    <p class="mb-0">{{ market_data.error }}</p>
    {% endif %}
</div>
{% else %}

<div class="row">
    <!-- Precio Actual y Datos Básicos -->
    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Precio Actual</h6>
                <span class="badge bg-primary text-white" id="updateTime"></span>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <h1 class="price-display" id="currentPrice">
                        ${{ market_data.current_price|number_format(2) }}
                    </h1>
                    <div id="priceChange" class="h4 mb-0 font-weight-bold text-gray-800">
                        {% if market_data.indicators.daily_change_pct is not none %}
                        <span class="{{ market_data.indicators.daily_change_pct >= 0 ? 'text-success' : 'text-danger' }}">
                            {{ market_data.indicators.daily_change_pct >= 0 ? '+' : '' }}{{ market_data.indicators.daily_change_pct|number_format(2) }}%
                        </span>
                        {% else %}
                        <span class="text-muted">--</span>
                        {% endif %}
                    </div>
                </div>
                
                <hr>
                
                <div class="row text-center mt-4">
                    <div class="col-6">
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="dailyLow">
                            {% if market_data.bars and market_data.bars|length > 0 %}
                            ${{ market_data.bars[0].low|number_format(2) }}
                            {% else %}
                            --
                            {% endif %}
                        </div>
                        <p class="text-muted small">Mínimo del Día</p>
                    </div>
                    <div class="col-6">
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="dailyHigh">
                            {% if market_data.bars and market_data.bars|length > 0 %}
                            ${{ market_data.bars[0].high|number_format(2) }}
                            {% else %}
                            --
                            {% endif %}
                        </div>
                        <p class="text-muted small">Máximo del Día</p>
                    </div>
                </div>
                
                <div class="row text-center mt-3">
                    <div class="col-6">
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="dailyVolume">
                            {% if market_data.bars and market_data.bars|length > 0 %}
                            {{ (market_data.bars[0].volume / 1000)|number_format(0) }}K
                            {% else %}
                            --
                            {% endif %}
                        </div>
                        <p class="text-muted small">Volumen</p>
                    </div>
                    <div class="col-6">
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="dailyOpen">
                            {% if market_data.bars and market_data.bars|length > 0 %}
                            ${{ market_data.bars[0].open|number_format(2) }}
                            {% else %}
                            --
                            {% endif %}
                        </div>
                        <p class="text-muted small">Apertura</p>
                    </div>
                </div>
                
                <hr>
                
                <div class="text-center mt-3">
                    <button id="refreshDataBtn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt fa-sm"></i> Actualizar Datos
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Indicadores Técnicos -->
    <div class="col-xl-4 col-lg-3 col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Indicadores Técnicos</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th>SMA (20)</th>
                                <td id="sma20Value">
                                    {% if market_data.indicators.sma20 is not none %}
                                    ${{ market_data.indicators.sma20|number_format(2) }}
                                    <small class="{{ market_data.current_price > market_data.indicators.sma20 ? 'text-success' : 'text-danger' }}">
                                        {{ market_data.current_price > market_data.indicators.sma20 ? 'Por encima' : 'Por debajo' }}
                                    </small>
                                    {% else %}
                                    No disponible
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>RSI (14)</th>
                                <td id="rsiValue">
                                    {% if market_data.indicators.rsi14 is not none %}
                                    {{ market_data.indicators.rsi14|number_format(2) }}
                                    <small class="{{ market_data.indicators.rsi14 > 70 ? 'text-danger' : (market_data.indicators.rsi14 < 30 ? 'text-success' : 'text-muted') }}">
                                        {{ market_data.indicators.rsi14 > 70 ? 'Sobrecomprado' : (market_data.indicators.rsi14 < 30 ? 'Sobrevendido' : 'Neutral') }}
                                    </small>
                                    {% else %}
                                    No disponible
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>ATR (14)</th>
                                <td id="atrValue">
                                    {% if market_data.indicators.atr14 is not none %}
                                    ${{ market_data.indicators.atr14|number_format(2) }}
                                    <small class="text-muted">
                                        {{ ((market_data.indicators.atr14 / market_data.current_price) * 100)|number_format(2) }}% volatilidad
                                    </small>
                                    {% else %}
                                    No disponible
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Prev. Cierre</th>
                                <td id="prevCloseValue">
                                    {% if market_data.indicators.prev_close is not none %}
                                    ${{ market_data.indicators.prev_close|number_format(2) }}
                                    {% else %}
                                    No disponible
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <hr>
                
                <h6 class="font-weight-bold">Niveles Clave</h6>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="card bg-light py-2 mb-2">
                            <div class="card-body py-1">
                                <strong>Soporte</strong><br>
                                <span id="supportLevel">
                                    {% if market_data.bars and market_data.bars|length > 0 %}
                                    ${{ (market_data.bars[0].low * 0.99)|number_format(2) }}
                                    {% else %}
                                    --
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light py-2 mb-2">
                            <div class="card-body py-1">
                                <strong>Resistencia</strong><br>
                                <span id="resistanceLevel">
                                    {% if market_data.bars and market_data.bars|length > 0 %}
                                    ${{ (market_data.bars[0].high * 1.01)|number_format(2) }}
                                    {% else %}
                                    --
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alertas Activas -->
    <div class="col-xl-4 col-lg-4 col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Alertas para {{ symbol }}</h6>
                <button class="btn btn-sm btn-primary" id="newAlertBtn">
                    <i class="fas fa-plus fa-sm"></i> Nueva
                </button>
            </div>
            <div class="card-body">
                <div id="activeAlertsContainer">
                    <!-- Aquí se cargarán las alertas activas de este símbolo -->
                    <div class="text-center text-muted">
                        <i class="fas fa-bell-slash fa-2x mb-3"></i>
                        <p>No hay alertas activas para {{ symbol }}</p>
                    </div>
                    
                    <!-- Ejemplo de una alerta (para referencia) -->
                    <div class="alert alert-primary d-flex justify-content-between align-items-center d-none">
                        <div>
                            <strong>{{ symbol }} > $100</strong><br>
                            <small class="text-muted">Creada: 25/03/2023</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="alert alert-info">
                    <h6 class="alert-heading"><i class="fas fa-lightbulb"></i> Sugerencias de Alertas</h6>
                    <ul class="mb-0 small">
                        <li>Movimiento de precio significativo (±5%)</li>
                        <li>Cruce de Media Móvil Simple (SMA)</li>
                        <li>RSI entra en zona de sobrecompra/sobreventa</li>
                        <li>Rompe niveles de soporte/resistencia</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Precio -->
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Gráfico de Precio</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                        <div class="dropdown-header">Timeframe:</div>
                        <a class="dropdown-item timeframe-option" href="#" data-timeframe="1Min">1 Minuto</a>
                        <a class="dropdown-item timeframe-option" href="#" data-timeframe="5Min">5 Minutos</a>
                        <a class="dropdown-item timeframe-option" href="#" data-timeframe="15Min">15 Minutos</a>
                        <a class="dropdown-item timeframe-option" href="#" data-timeframe="1H">1 Hora</a>
                        <a class="dropdown-item timeframe-option active" href="#" data-timeframe="1D">1 Día</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="priceChart" style="min-height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Historial de Barras -->
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Historial de Precios</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="priceHistoryTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Apertura</th>
                                <th>Máximo</th>
                                <th>Mínimo</th>
                                <th>Cierre</th>
                                <th>Volumen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if market_data.bars %}
                            {% for bar in market_data.bars %}
                            <tr>
                                <td>{{ bar.timestamp }}</td>
                                <td>${{ bar.open|number_format(2) }}</td>
                                <td>${{ bar.high|number_format(2) }}</td>
                                <td>${{ bar.low|number_format(2) }}</td>
                                <td>${{ bar.close|number_format(2) }}</td>
                                <td>{{ bar.volume|number_format(0) }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">No hay datos históricos disponibles</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Nueva alerta rápida -->
    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Crear Alerta Rápida</h6>
            </div>
            <div class="card-body">
                <form id="quickAlertForm">
                    <div class="mb-3">
                        <label for="alertType" class="form-label">Tipo de Alerta</label>
                        <select class="form-select" id="alertType" name="alertType">
                            <option value="price_above">Precio por encima de...</option>
                            <option value="price_below">Precio por debajo de...</option>
                            <option value="price_percent_change">Cambio porcentual de...</option>
                            <option value="rsi_above">RSI por encima de...</option>
                            <option value="rsi_below">RSI por debajo de...</option>
                            <option value="sma_cross">Cruce de SMA</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="valueContainer">
                        <label for="alertValue" class="form-label">Valor</label>
                        <div class="input-group">
                            <span class="input-group-text" id="valuePrefix">$</span>
                            <input type="number" step="0.01" class="form-control" id="alertValue" name="alertValue" 
                                   value="{{ market_data.current_price|number_format(2, '.', '') }}">
                            <span class="input-group-text" id="valueSuffix"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="alertName" class="form-label">Nombre de la Alerta</label>
                        <input type="text" class="form-control" id="alertName" name="alertName" 
                               value="{{ symbol }} Alerta">
                    </div>
                    
                    <div class="mb-3">
                        <label for="alertPriority" class="form-label">Prioridad</label>
                        <select class="form-select" id="alertPriority" name="alertPriority">
                            <option value="low">Baja</option>
                            <option value="medium" selected>Media</option>
                            <option value="high">Alta</option>
                            <option value="critical">Crítica</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-bell fa-sm text-white-50"></i> Crear Alerta
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Nueva Alerta Avanzada -->
<div class="modal fade" id="newAlertModal" tabindex="-1" aria-labelledby="newAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newAlertModalLabel">Nueva Alerta para {{ symbol }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="advancedAlertForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="advAlertName" class="form-label">Nombre de la Alerta</label>
                                <input type="text" class="form-control" id="advAlertName" name="advAlertName" 
                                       value="{{ symbol }} Alerta Avanzada" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="advAlertPriority" class="form-label">Prioridad</label>
                                <select class="form-select" id="advAlertPriority" name="advAlertPriority">
                                    <option value="low">Baja</option>
                                    <option value="medium" selected>Media</option>
                                    <option value="high">Alta</option>
                                    <option value="critical">Crítica</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="advAlertExpiration" class="form-label">Expiración</label>
                                <select class="form-select" id="advAlertExpiration" name="advAlertExpiration">
                                    <option value="1day">1 día</option>
                                    <option value="3days" selected>3 días</option>
                                    <option value="1week">1 semana</option>
                                    <option value="1month">1 mes</option>
                                    <option value="never">No expirar</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Notificaciones</label>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="advNotifyBrowser" name="advNotifyBrowser" checked>
                                    <label class="form-check-label" for="advNotifyBrowser">Notificación del navegador</label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="advNotifyEmail" name="advNotifyEmail">
                                    <label class="form-check-label" for="advNotifyEmail">Correo electrónico</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="advNotifySound" name="advNotifySound" checked>
                                    <label class="form-check-label" for="advNotifySound">Alerta sonora</label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="advAlertDescription" class="form-label">Descripción</label>
                                <textarea class="form-control" id="advAlertDescription" name="advAlertDescription" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h5 class="text-primary">Condiciones</h5>
                    <p class="text-muted small">Puedes configurar múltiples condiciones para esta alerta.</p>
                    
                    <div id="conditionsContainer">
                        <div class="condition-row mb-3 p-2 border rounded">
                            <div class="row">
                                <div class="col-md-4">
                                    <select class="form-select condition-type">
                                        <option value="price_above">Precio por encima de</option>
                                        <option value="price_below">Precio por debajo de</option>
                                        <option value="price_percent_change">Cambio porcentual</option>
                                        <option value="rsi_above">RSI por encima de</option>
                                        <option value="rsi_below">RSI por debajo de</option>
                                        <option value="sma_cross">Cruce de SMA</option>
                                        <option value="volume_increase">Aumento de volumen</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text condition-prefix">$</span>
                                        <input type="number" step="0.01" class="form-control condition-value" 
                                               value="{{ market_data.current_price|number_format(2, '.', '') }}">
                                        <span class="input-group-text condition-suffix"></span>
                                    </div>
                                </div>
                                
                                <div class="col-md-3">
                                    <select class="form-select condition-timeframe">
                                        <option value="realtime">Tiempo real</option>
                                        <option value="1min">1 minuto</option>
                                        <option value="5min">5 minutos</option>
                                        <option value="15min">15 minutos</option>
                                        <option value="1hour">1 hora</option>
                                        <option value="1day" selected>1 día</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger remove-condition">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="addConditionBtn">
                            <i class="fas fa-plus"></i> Añadir Condición
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="conditionLogic" class="form-label">Lógica de Condiciones</label>
                        <select class="form-select" id="conditionLogic" name="conditionLogic">
                            <option value="all" selected>Todas las condiciones deben cumplirse (AND)</option>
                            <option value="any">Cualquier condición debe cumplirse (OR)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveAdvancedAlertBtn">Guardar Alerta</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Inicializar la fecha/hora de actualización
        $('#updateTime').text('Actualizado: ' + new Date().toLocaleTimeString());
        
        // Inicializar gráfico si hay datos
        {% if market_data and market_data.success and market_data.bars %}
        // Preparar datos para el gráfico
        const chartLabels = [];
        const chartData = [];
        
        {% for bar in market_data.bars|reverse %}
        chartLabels.push('{{ bar.timestamp }}');
        chartData.push({
            x: '{{ bar.timestamp }}',
            o: {{ bar.open }},
            h: {{ bar.high }},
            l: {{ bar.low }},
            c: {{ bar.close }}
        });
        {% endfor %}
        
        // Crear el gráfico
        const ctx = document.getElementById('priceChart').getContext('2d');
        const priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: '{{ symbol }} - Precio',
                    data: chartData.map(item => item.c),
                    borderColor: 'rgba(78, 115, 223, 1)',
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    pointRadius: 3,
                    pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                    pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        ticks: {
                            callback: function(value) {
                                return ' + value.toFixed(2);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataIndex = context.dataIndex;
                                const data = chartData[dataIndex];
                                return [
                                    'Open:  + data.o.toFixed(2),
                                    'High:  + data.h.toFixed(2),
                                    'Low:  + data.l.toFixed(2),
                                    'Close:  + data.c.toFixed(2)
                                ];
                            }
                        }
                    }
                }
            }
        });
        
        // Manejar cambio de timeframe
        $('.timeframe-option').click(function(e) {
            e.preventDefault();
            
            // Actualizar UI
            $('.timeframe-option').removeClass('active');
            $(this).addClass('active');
            
            // Obtener nuevo timeframe
            const timeframe = $(this).data('timeframe');
            
            // Cargar datos para ese timeframe
            $.ajax({
                url: "{{ url_for('alpaca.get_market_data', symbol=symbol) }}",
                method: "GET",
                data: {
                    timeframe: timeframe,
                    limit: 50
                },
                beforeSend: function() {
                    // Mostrar spinner o similar
                },
                success: function(response) {
                    if (response.success && response.bars) {
                        // Actualizar chart con nuevos datos
                        const newLabels = [];
                        const newData = [];
                        
                        for (let i = response.bars.length - 1; i >= 0; i--) {
                            const bar = response.bars[i];
                            newLabels.push(bar.timestamp);
                            newData.push(bar.close);
                        }
                        
                        priceChart.data.labels = newLabels;
                        priceChart.data.datasets[0].data = newData;
                        priceChart.update();
                        
                        // Actualizar hora de actualización
                        $('#updateTime').text('Actualizado: ' + new Date().toLocaleTimeString());
                    }
                },
                error: function() {
                    alert('Error al cargar datos para el timeframe seleccionado');
                }
            });
        });
        {% endif %}
        
        // Manejar botón de refrescar datos
        $('#refreshDataBtn').click(function() {
            location.reload();
        });
        
        // Manejar botones de alerta
        $('#createAlertBtn, #newAlertBtn').click(function(e) {
            e.preventDefault();
            $('#newAlertModal').modal('show');
        });
        
        // Actualizar interfaz según tipo de alerta rápida
        $('#alertType').change(function() {
            const alertType = $(this).val();
            const $valuePrefix = $('#valuePrefix');
            const $valueSuffix = $('#valueSuffix');
            const $alertValue = $('#alertValue');
            
            switch(alertType) {
                case 'price_above':
                case 'price_below':
                    $valuePrefix.text(');
                    $valueSuffix.text('');
                    $alertValue.val({{ market_data.current_price|number_format(2, '.', '') }});
                    $alertValue.attr('step', '0.01');
                    break;
                case 'price_percent_change':
                    $valuePrefix.text('');
                    $valueSuffix.text('%');
                    $alertValue.val('5.00');
                    $alertValue.attr('step', '0.1');
                    break;
                case 'rsi_above':
                case 'rsi_below':
                    $valuePrefix.text('');
                    $valueSuffix.text('');
                    $alertValue.val(alertType === 'rsi_above' ? '70' : '30');
                    $alertValue.attr('step', '1');
                    break;
                case 'sma_cross':
                    $valuePrefix.text('SMA');
                    $valueSuffix.text('períodos');
                    $alertValue.val('20');
                    $alertValue.attr('step', '1');
                    break;
            }
        });
        
        // Manejar envío del formulario de alerta rápida
        $('#quickAlertForm').submit(function(e) {
            e.preventDefault();
            
            // Aquí iría el código para enviar la alerta al backend
            alert('Esta funcionalidad aún no está implementada por completo. Se agregaría la alerta a la integración con Alpaca.');
        });
        
        // Añadir condición en formulario avanzado
        $('#addConditionBtn').click(function() {
            const newCondition = $('.condition-row').first().clone();
            newCondition.find('input').val("{{ market_data.current_price|number_format(2, '.', '') }}");
            newCondition.appendTo('#conditionsContainer');
        });
        
        // Eliminar condición
        $(document).on('click', '.remove-condition', function() {
            // No eliminar si es la única condición
            if ($('.condition-row').length > 1) {
                $(this).closest('.condition-row').remove();
            } else {
                alert('Debe haber al menos una condición');
            }
        });
        
        // Actualizar prefijos/sufijos según tipo de condición
        $(document).on('change', '.condition-type', function() {
            const conditionType = $(this).val();
            const row = $(this).closest('.condition-row');
            const prefix = row.find('.condition-prefix');
            const suffix = row.find('.condition-suffix');
            const valueInput = row.find('.condition-value');
            
            switch(conditionType) {
                case 'price_above':
                case 'price_below':
                    prefix.text(');
                    suffix.text('');
                    valueInput.val({{ market_data.current_price|number_format(2, '.', '') }});
                    break;
                case 'price_percent_change':
                    prefix.text('');
                    suffix.text('%');
                    valueInput.val('5.00');
                    break;
                case 'rsi_above':
                case 'rsi_below':
                    prefix.text('');
                    suffix.text('');
                    valueInput.val(conditionType === 'rsi_above' ? '70' : '30');
                    break;
                case 'sma_cross':
                    prefix.text('SMA');
                    suffix.text('períodos');
                    valueInput.val('20');
                    break;
                case 'volume_increase':
                    prefix.text('');
                    suffix.text('%');
                    valueInput.val('150');
                    break;
            }
        });
        
        // Guardar alerta avanzada
        $('#saveAdvancedAlertBtn').click(function() {
            // Crear objeto para las condiciones
            const conditions = [];
            
            $('.condition-row').each(function() {
                const type = $(this).find('.condition-type').val();
                const value = $(this).find('.condition-value').val();
                const timeframe = $(this).find('.condition-timeframe').val();
                
                conditions.push({
                    type: type,
                    value: value,
                    timeframe: timeframe
                });
            });
            
            const alertData = {
                name: $('#advAlertName').val(),
                symbol: '{{ symbol }}',
                priority: $('#advAlertPriority').val(),
                expiration: $('#advAlertExpiration').val(),
                notify: {
                    browser: $('#advNotifyBrowser').is(':checked'),
                    email: $('#advNotifyEmail').is(':checked'),
                    sound: $('#advNotifySound').is(':checked')
                },
                description: $('#advAlertDescription').val(),
                conditions: conditions,
                logic: $('#conditionLogic').val()
            };
            
            console.log('Alerta a guardar:', alertData);
            alert('Esta funcionalidad aún no está implementada por completo. La alerta se enviaría al backend.');
            
            // Cerrar modal
            $('#newAlertModal').modal('hide');
        });
    });
</script>
{% endblock %}