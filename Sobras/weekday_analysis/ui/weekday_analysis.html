<!-- addons/weekday_analysis/ui/weekday_analysis.html -->
{% extends 'base.html' %}

{% block title %}Análisis por Día - DAS Trader Analyzer{% endblock %}

{% block header %}Análisis por Día de la Semana{% endblock %}

{% block content %}
<div class="row">
    <!-- Resumen de rendimiento por día -->
    <div class="col-lg-12 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Rendimiento por Día de la Semana</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                        aria-labelledby="dropdownMenuLink">
                        <div class="dropdown-header">Opciones:</div>
                        <a class="dropdown-item" href="#" id="togglePL">Mostrar/Ocultar P&L</a>
                        <a class="dropdown-item" href="#" id="toggleWinRate">Mostrar/Ocultar Ratio de Éxito</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="weekdayChart" style="height: 20rem;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Estadísticas detalladas -->
    <div class="col-lg-12 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Estadísticas por Día de la Semana</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="weekdayTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Día</th>
                                <th>P&L Total</th>
                                <th>Operaciones</th>
                                <th>Ganadoras</th>
                                <th>% Éxito</th>
                                <th>P&L Promedio</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in weekday_data %}
                            <tr>
                                <td>{{ day.weekday }}</td>
                                <td class="{% if day.totalPL > 0 %}text-success{% elif day.totalPL < 0 %}text-danger{% endif %}">
                                    {{ "%.2f"|format(day.totalPL) }}
                                </td>
                                <td>{{ day.totalTrades }}</td>
                                <td>{{ day.winningTrades }}</td>
                                <td>{{ "%.1f"|format(day.winRate) }}%</td>
                                <td class="{% if day.avgPL > 0 %}text-success{% elif day.avgPL < 0 %}text-danger{% endif %}">
                                    {{ "%.2f"|format(day.avgPL) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Mejor día, peor día y día más activo -->
    <div class="col-xl-4 col-md-4 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Mejor Día</div>
                        {% if best_day %}
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ best_day.weekday }}</div>
                        <div class="mt-2 text-xs">P&L: <span class="text-success">{{ "%.2f"|format(best_day.totalPL) }}</span></div>
                        <div class="text-xs">Éxito: {{ "%.1f"|format(best_day.winRate) }}%</div>
                        {% else %}
                        <div class="h5 mb-0 font-weight-bold text-gray-400">No hay datos</div>
                        {% endif %}
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-plus fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-md-4 mb-4">
        <div class="card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Peor Día</div>
                        {% if worst_day %}
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ worst_day.weekday }}</div>
                        <div class="mt-2 text-xs">P&L: <span class="text-danger">{{ "%.2f"|format(worst_day.totalPL) }}</span></div>
                        <div class="text-xs">Éxito: {{ "%.1f"|format(worst_day.winRate) }}%</div>
                        {% else %}
                        <div class="h5 mb-0 font-weight-bold text-gray-400">No hay datos</div>
                        {% endif %}
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-minus fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-md-4 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Día Más Activo</div>
                        {% if most_active_day %}
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ most_active_day.weekday }}</div>
                        <div class="mt-2 text-xs">Operaciones: {{ most_active_day.totalTrades }}</div>
                        <div class="text-xs">P&L Prom: <span class="{% if most_active_day.avgPL > 0 %}text-success{% elif most_active_day.avgPL < 0 %}text-danger{% endif %}">{{ "%.2f"|format(most_active_day.avgPL) }}</span></div>
                        {% else %}
                        <div class="h5 mb-0 font-weight-bold text-gray-400">No hay datos</div>
                        {% endif %}
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Datos para los gráficos
const weekdayData = {{ weekday_json|safe }};

// Configurar gráfico de rendimiento por día
const ctx = document.getElementById('weekdayChart').getContext('2d');
const weekdayChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: weekdayData.map(day => day.weekday),
        datasets: [
            {
                label: 'P&L Total',
                data: weekdayData.map(day => day.totalPL),
                backgroundColor: weekdayData.map(day => day.totalPL >= 0 ? 'rgba(28, 200, 138, 0.8)' : 'rgba(231, 74, 59, 0.8)'),
                borderColor: weekdayData.map(day => day.totalPL >= 0 ? 'rgb(28, 200, 138)' : 'rgb(231, 74, 59)'),
                borderWidth: 1,
                yAxisID: 'y-axis-1'
            },
            {
                label: '% Éxito',
                data: weekdayData.map(day => day.winRate),
                backgroundColor: 'rgba(78, 115, 223, 0.2)',
                borderColor: 'rgba(78, 115, 223, 1)',
                borderWidth: 2,
                type: 'line',
                yAxisID: 'y-axis-2'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            yAxes: [
                {
                    id: 'y-axis-1',
                    type: 'linear',
                    position: 'left',
                    ticks: {
                        beginAtZero: false,
                        callback: function(value) {
                            return value.toFixed(2);
                        }
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'P&L Total'
                    }
                },
                {
                    id: 'y-axis-2',
                    type: 'linear',
                    position: 'right',
                    ticks: {
                        beginAtZero: true,
                        max: 100,
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    scaleLabel: {
                        display: true,
                        labelString: '% Éxito'
                    },
                    gridLines: {
                        drawOnChartArea: false
                    }
                }
            ]
        },
        tooltips: {
            mode: 'index',
            intersect: false,
            callbacks: {
                label: function(tooltipItem, data) {
                    let label = data.datasets[tooltipItem.datasetIndex].label || '';
                    if (label) {
                        label += ': ';
                    }
                    
                    if (tooltipItem.datasetIndex === 0) {
                        label += tooltipItem.value;
                    } else {
                        label += tooltipItem.value + '%';
                    }
                    return label;
                }
            }
        }
    }
});

// Toggles para mostrar/ocultar datasets
document.getElementById('togglePL').addEventListener('click', function() {
    const isVisible = weekdayChart.isDatasetVisible(0);
    weekdayChart.setDatasetVisibility(0, !isVisible);
    weekdayChart.update();
});

document.getElementById('toggleWinRate').addEventListener('click', function() {
    const isVisible = weekdayChart.isDatasetVisible(1);
    weekdayChart.setDatasetVisibility(1, !isVisible);
    weekdayChart.update();
});

// Inicializar tabla con DataTables
$(document).ready(function() {
    $('#weekdayTable').DataTable({
        "order": [[1, "desc"]],
        "language": {
            "lengthMenu": "Mostrar _MENU_ registros por página",
            "zeroRecords": "No se encontraron resultados",
            "info": "Mostrando página _PAGE_ de _PAGES_",
            "infoEmpty": "No hay registros disponibles",
            "infoFiltered": "(filtrado de _MAX_ registros totales)",
            "search": "Buscar:",
            "paginate": {
                "first": "Primero",
                "last": "Último",
                "next": "Siguiente",
                "previous": "Anterior"
            }
        }
    });
});
</script>
{% endblock %}