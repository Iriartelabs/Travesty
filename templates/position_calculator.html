{% extends 'base.html' %}

{% block title %}Calculadora de Posiciones - DAS Trader Analyzer{% endblock %}

{% block header %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Calculadora de Posiciones</h1>
    <a href="{{ url_for('trading_alerts.trading_alerts') }}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
        <i class="fas fa-arrow-left fa-sm text-white-50"></i> Volver a Alertas
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Calculadora de posiciones -->
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Calculadora de Tamaño de Posición</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                        <div class="dropdown-header">Opciones:</div>
                        <a class="dropdown-item" href="#" id="savePreset">Guardar como Preset</a>
                        <a class="dropdown-item" href="#" id="clearForm">Limpiar Formulario</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#helpModal">Ayuda</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form id="positionCalcForm">
                    <div class="row">
                        <!-- Columna izquierda - Capital y Riesgo -->
                        <div class="col-md-6">
                            <h5 class="text-primary mb-3">Capital y Riesgo</h5>
                            
                            <div class="mb-3">
                                <label for="accountSize" class="form-label">Capital de la Cuenta ($)</label>
                                <input type="number" class="form-control" id="accountSize" name="accountSize" value="10000" min="100" step="100" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="riskPercentage" class="form-label">Riesgo por Operación (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="riskPercentage" name="riskPercentage" value="1" min="0.1" max="10" step="0.1" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text text-muted">
                                    Máximo a perder en una operación
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="stopLoss" class="form-label">Distancia de Stop Loss (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="stopLoss" name="stopLoss" value="2" min="0.1" step="0.1" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text text-muted">
                                    Porcentaje desde punto de entrada hasta stop loss
                                </div>
                            </div>
                        </div>
                        
                        <!-- Columna derecha - Detalles de Entrada -->
                        <div class="col-md-6">
                            <h5 class="text-primary mb-3">Detalles de Operación</h5>
                            
                            <div class="mb-3">
                                <label for="entryPrice" class="form-label">Precio de Entrada ($)</label>
                                <input type="number" class="form-control" id="entryPrice" name="entryPrice" value="50" min="0.01" step="0.01" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="stopPrice" class="form-label">Precio de Stop Loss ($)</label>
                                <input type="number" class="form-control" id="stopPrice" name="stopPrice" placeholder="Calculado automáticamente" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="targetPrice" class="form-label">Precio Objetivo ($)</label>
                                <input type="number" class="form-control" id="targetPrice" name="targetPrice" placeholder="Opcional" step="0.01">
                                <div class="form-text text-muted">
                                    Opcional - Para calcular ratio riesgo/recompensa
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button type="button" id="calculateBtn" class="btn btn-primary btn-lg">
                            <i class="fas fa-calculator fa-sm text-white-50 me-1"></i> Calcular Posición
                        </button>
                    </div>
                </form>
                
                <div id="resultCard" class="card border-left-success shadow h-100 py-2 mt-4" style="display: none;">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="h5 mb-0 font-weight-bold text-success text-uppercase mb-3">Resultado del Cálculo</div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2">Capital en Riesgo: <strong id="dollarRisk">$100.00</strong></p>
                                        <p class="mb-2">Tamaño de Posición: <strong id="positionSize">$2,500.00</strong></p>
                                        <p class="mb-2">Número de Acciones: <strong id="sharesCount">50 acciones</strong></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2">Stop Loss: <strong id="stopLossResult">$49.00 (-2.00%)</strong></p>
                                        <p class="mb-2">Pérdida Potencial: <strong id="potentialLoss">-$100.00</strong></p>
                                        <p class="mb-2">Ratio Riesgo/Recompensa: <strong id="riskRewardRatio">1:2.5</strong></p>
                                    </div>
                                </div>
                                
                                <hr>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" id="saveTradePlan">
                                            <i class="fas fa-save fa-sm"></i> Guardar Plan
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary ms-2" id="shareResult">
                                            <i class="fas fa-share-alt fa-sm"></i> Compartir
                                        </button>
                                    </div>
                                    <div class="text-muted small">
                                        <i class="fas fa-info-circle"></i> Recuerda: Gestión de riesgo efectiva = Trading sostenible
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Columna de presets y ayuda -->
    <div class="col-xl-4 col-lg-5">
        <!-- Presets guardados -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Presets Guardados</h6>
            </div>
            <div class="card-body">
                <div id="noPresetsMessage">
                    <p class="text-center text-muted">No hay presets guardados</p>
                    <p class="text-center small">Guarda tus cálculos frecuentes para usarlos rápidamente</p>
                </div>
                <div id="presetsList" style="display: none;">
                    <div class="list-group">
                        <!-- Los presets se cargarán dinámicamente aquí -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Consejos y parámetros comunes -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Parámetros Comunes</h6>
            </div>
            <div class="card-body">
                <h6 class="font-weight-bold">Porcentajes de Riesgo Sugeridos:</h6>
                <ul class="mb-3">
                    <li><strong>Conservador:</strong> 0.5% - 1%</li>
                    <li><strong>Moderado:</strong> 1% - 2%</li>
                    <li><strong>Agresivo:</strong> 2% - 3%</li>
                </ul>
                
                <h6 class="font-weight-bold">Ratios de Riesgo/Recompensa Comunes:</h6>
                <ul>
                    <li><strong>Mínimo recomendado:</strong> 1:2</li>
                    <li><strong>Óptimo:</strong> 1:3 o superior</li>
                </ul>
                
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-lightbulb"></i> <strong>Consejo:</strong> Nunca arriesgues más del 2% de tu capital en una sola operación a menos que tengas una estrategia muy probada y específica.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Ayuda -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="helpModalLabel">Guía de la Calculadora de Posiciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5 class="text-primary">¿Cómo funciona?</h5>
                <p>La calculadora de posiciones te ayuda a determinar el tamaño óptimo de tus operaciones basado en tu capital y tolerancia al riesgo. Sigue estos pasos:</p>
                
                <ol>
                    <li><strong>Capital de la Cuenta:</strong> Ingresa tu capital de trading total.</li>
                    <li><strong>Riesgo por Operación:</strong> El porcentaje de tu capital que estás dispuesto a arriesgar (recomendado: 1-2%).</li>
                    <li><strong>Distancia de Stop Loss:</strong> Cuánto porcentaje estás dispuesto a permitir que baje el precio antes de salir.</li>
                    <li><strong>Precio de Entrada:</strong> El precio al que planeas entrar en la operación.</li>
                    <li><strong>Precio Objetivo (opcional):</strong> Tu objetivo de precio para calcular el ratio riesgo/recompensa.</li>
                </ol>
                
                <h5 class="text-primary mt-4">Fórmulas utilizadas</h5>
                <ul>
                    <li><strong>Capital en Riesgo ($):</strong> Capital de Cuenta × Riesgo por Operación (%)</li>
                    <li><strong>Precio de Stop Loss ($):</strong> Precio de Entrada × (1 - Distancia de Stop Loss / 100)</li>
                    <li><strong>Número de Acciones:</strong> Capital en Riesgo / (Precio de Entrada - Precio de Stop Loss)</li>
                    <li><strong>Tamaño de Posición ($):</strong> Número de Acciones × Precio de Entrada</li>
                    <li><strong>Ratio Riesgo/Recompensa:</strong> (Precio Objetivo - Precio de Entrada) / (Precio de Entrada - Precio de Stop Loss)</li>
                </ul>
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Importante:</strong> Esta calculadora es una herramienta de ayuda. Siempre utiliza tu propio juicio y considera factores adicionales como la liquidez del mercado, la volatilidad y tu estrategia general de trading.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Variables para almacenar presets
        let savedPresets = JSON.parse(localStorage.getItem('positionCalculatorPresets')) || [];
        updatePresetsList();
        
        // Calcular stop loss automáticamente cuando se cambia el precio de entrada o el porcentaje
        $('#entryPrice, #stopLoss').on('input', function() {
            calculateStopPrice();
        });
        
        // Calcular posición al hacer clic en el botón
        $('#calculateBtn').on('click', function() {
            calculatePosition();
        });
        
        // Limpiar formulario
        $('#clearForm').on('click', function(e) {
            e.preventDefault();
            $('#positionCalcForm')[0].reset();
            $('#resultCard').hide();
            $('#accountSize').val(10000);
            $('#riskPercentage').val(1);
            $('#stopLoss').val(2);
            $('#entryPrice').val(50);
            calculateStopPrice();
        });
        
        // Guardar preset
        $('#savePreset').on('click', function(e) {
            e.preventDefault();
            
            const presetName = prompt('Nombre para este preset:');
            if (!presetName) return;
            
            const preset = {
                id: Date.now(),
                name: presetName,
                accountSize: parseFloat($('#accountSize').val()),
                riskPercentage: parseFloat($('#riskPercentage').val()),
                stopLoss: parseFloat($('#stopLoss').val()),
                entryPrice: parseFloat($('#entryPrice').val()),
                targetPrice: parseFloat($('#targetPrice').val()) || null
            };
            
            savedPresets.push(preset);
            localStorage.setItem('positionCalculatorPresets', JSON.stringify(savedPresets));
            
            updatePresetsList();
            alert('Preset guardado correctamente');
        });
        
        // Guardar plan de trading
        $('#saveTradePlan').on('click', function() {
            alert('Funcionalidad de guardar plan de trading pendiente de implementación');
            // TODO: Implementar guardado de plan en la base de datos o como parte del sistema de alertas
        });
        
        // Compartir resultado
        $('#shareResult').on('click', function() {
            const resultText = `
Plan de Trading:
- Capital en Riesgo: ${$('#dollarRisk').text()}
- Tamaño de Posición: ${$('#positionSize').text()}
- Número de Acciones: ${$('#sharesCount').text()}
- Stop Loss: ${$('#stopLossResult').text()}
- Ratio R/R: ${$('#riskRewardRatio').text()}
            `;
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(resultText.trim()).then(function() {
                alert('Resultado copiado al portapapeles');
            });
        });
        
        // Función para calcular precio de stop automáticamente
        function calculateStopPrice() {
            const entryPrice = parseFloat($('#entryPrice').val()) || 0;
            const stopLossPercent = parseFloat($('#stopLoss').val()) || 0;
            
            if (entryPrice > 0 && stopLossPercent > 0) {
                const stopPrice = entryPrice * (1 - stopLossPercent / 100);
                $('#stopPrice').val(stopPrice.toFixed(2));
            } else {
                $('#stopPrice').val('');
            }
        }
        
        // Función principal para calcular la posición
        function calculatePosition() {
            // Obtener valores del formulario
            const accountSize = parseFloat($('#accountSize').val()) || 0;
            const riskPercentage = parseFloat($('#riskPercentage').val()) || 0;
            const entryPrice = parseFloat($('#entryPrice').val()) || 0;
            const stopPrice = parseFloat($('#stopPrice').val()) || 0;
            const targetPrice = parseFloat($('#targetPrice').val()) || 0;
            
            // Validaciones
            if (accountSize <= 0 || riskPercentage <= 0 || entryPrice <= 0 || stopPrice <= 0) {
                alert('Por favor, completa todos los campos correctamente');
                return;
            }
            
            if (stopPrice >= entryPrice) {
                alert('El precio de stop loss debe ser menor que el precio de entrada');
                return;
            }
            
            // Realizar cálculos
            const dollarRisk = accountSize * (riskPercentage / 100);
            const priceDifference = entryPrice - stopPrice;
            const shares = Math.floor(dollarRisk / priceDifference);
            const positionSize = shares * entryPrice;
            const actualRisk = shares * priceDifference;
            
            // Calcular ratio riesgo/recompensa si hay precio objetivo
            let riskRewardRatio = 'N/A';
            if (targetPrice > entryPrice) {
                const reward = targetPrice - entryPrice;
                const risk = entryPrice - stopPrice;
                const ratio = reward / risk;
                riskRewardRatio = `1:${ratio.toFixed(1)}`;
            }
            
            // Mostrar resultados
            $('#dollarRisk').text('$' + dollarRisk.toFixed(2));
            $('#positionSize').text('$' + positionSize.toFixed(2));
            $('#sharesCount').text(shares + ' acciones');
            $('#stopLossResult').text('$' + stopPrice.toFixed(2) + ' (' + (-parseFloat($('#stopLoss').val())).toFixed(2) + '%)');
            $('#potentialLoss').text('-$' + actualRisk.toFixed(2));
            $('#riskRewardRatio').text(riskRewardRatio);
            
            // Mostrar tarjeta de resultados
            $('#resultCard').show();
        }
        
        // Función para actualizar la lista de presets
        function updatePresetsList() {
            const $presetsList = $('#presetsList');
            const $noPresetsMessage = $('#noPresetsMessage');
            
            if (savedPresets.length === 0) {
                $presetsList.hide();
                $noPresetsMessage.show();
                return;
            }
            
            $presetsList.empty();
            $presetsList.show();
            $noPresetsMessage.hide();
            
            // Crear lista de presets
            const $listGroup = $('<div class="list-group"></div>');
            
            savedPresets.forEach(function(preset, index) {
                const $item = $(`
                    <a href="#" class="list-group-item list-group-item-action preset-item" data-index="${index}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${preset.name}</h6>
                            <small>Riesgo: ${preset.riskPercentage}%</small>
                        </div>
                        <p class="mb-1 small">Entrada: $${preset.entryPrice}, Stop: ${preset.stopLoss}%</p>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Capital: $${preset.accountSize}</small>
                            <button class="btn btn-sm btn-danger delete-preset" data-index="${index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </a>
                `);
                
                $listGroup.append($item);
            });
            
            $presetsList.append($listGroup);
            
            // Event handler para cargar preset
            $('.preset-item').on('click', function(e) {
                e.preventDefault();
                if (!$(e.target).hasClass('delete-preset') && !$(e.target).parent().hasClass('delete-preset')) {
                    const index = $(this).data('index');
                    loadPreset(index);
                }
            });
            
            // Event handler para eliminar preset
            $('.delete-preset').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const index = $(this).data('index');
                deletePreset(index);
            });
        }
        
        // Cargar un preset guardado
        function loadPreset(index) {
            if (index >= 0 && index < savedPresets.length) {
                const preset = savedPresets[index];
                
                $('#accountSize').val(preset.accountSize);
                $('#riskPercentage').val(preset.riskPercentage);
                $('#stopLoss').val(preset.stopLoss);
                $('#entryPrice').val(preset.entryPrice);
                
                if (preset.targetPrice) {
                    $('#targetPrice').val(preset.targetPrice);
                } else {
                    $('#targetPrice').val('');
                }
                
                calculateStopPrice();
                calculatePosition();
            }
        }
        
        // Eliminar un preset
        function deletePreset(index) {
            if (confirm('¿Estás seguro de eliminar este preset?')) {
                savedPresets.splice(index, 1);
                localStorage.setItem('positionCalculatorPresets', JSON.stringify(savedPresets));
                updatePresetsList();
            }
        }
        
        // Inicializar valor de stop price
        calculateStopPrice();
    });
</script>
{% endblock %}