{% extends 'base.html' %}

{% block title %}Alpaca Integration - DAS Trader Analyzer{% endblock %}

{% block header %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Alpaca Integration</h1>
    <a href="/alpaca/settings" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
        <i class="fas fa-cog fa-sm text-white-50"></i> Configurar API
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Status Card -->
    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Estado de la Conexión</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="connectionStatus">
                            <span class="text-warning">Verificando...</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-plug fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Info Card -->
    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            API Endpoint</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="apiEndpoint">
                            Cargando...
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-server fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Card -->
    <div class="col-xl-4 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            API Key</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="apiKeyPreview">
                            <span class="text-muted">No configurado</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-key fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Integración con Alpaca</h6>
            </div>
            <div class="card-body" id="mainContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Verificando configuración...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Verificar si hay credenciales cargadas por el servidor
        const apiKey = "{{ api_key|safe }}";
        const baseUrl = "{{ base_url|safe }}";
        
        // Actualizar el estado de la conexión
        if (apiKey) {
            $('#connectionStatus').html('<span class="text-success">Configurado</span>');
            $('#apiEndpoint').text(baseUrl);
            $('#apiKeyPreview').text(apiKey.substring(0, 4) + '...');
            
            // Mostrar interfaz para usuario configurado
            $('#mainContent').html(`
                <div class="alert alert-success">
                    <h5>API configurada correctamente</h5>
                    <p>Tu conexión a Alpaca está configurada. Puedes usar las siguientes funcionalidades:</p>
                    <ul>
                        <li>Consultar tu posición actual</li>
                        <li>Ver historial de órdenes</li>
                        <li>Enviar órdenes a Alpaca</li>
                    </ul>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-wallet fa-3x mb-3 text-primary"></i>
                                <h5 class="card-title">Posiciones</h5>
                                <p class="card-text">Ver tus posiciones actuales en el mercado</p>
                                <button class="btn btn-primary" id="btnPositions">Ver Posiciones</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-history fa-3x mb-3 text-info"></i>
                                <h5 class="card-title">Historial</h5>
                                <p class="card-text">Consultar el historial de órdenes ejecutadas</p>
                                <button class="btn btn-info" id="btnHistory">Ver Historial</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-paper-plane fa-3x mb-3 text-success"></i>
                                <h5 class="card-title">Enviar Órdenes</h5>
                                <p class="card-text">Envía órdenes directamente desde la plataforma</p>
                                <button class="btn btn-success" id="btnOrders">Nueva Orden</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="apiResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary" id="resultsTitle">Resultados</h6>
                        </div>
                        <div class="card-body">
                            <div id="resultsContent" class="p-3">
                                <!-- Aquí se mostrarán los resultados de la API -->
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            // Añadir event listeners para los botones
            setupButtonHandlers();
            
        } else {
            $('#connectionStatus').html('<span class="text-danger">No Configurado</span>');
            $('#apiEndpoint').text('No configurado');
            $('#apiKeyPreview').html('<span class="text-muted">No configurado</span>');
            
            // Mostrar interfaz para usuario no configurado
            $('#mainContent').html(`
                <div class="alert alert-warning">
                    <h5>Configuración pendiente</h5>
                    <p>Para usar la integración con Alpaca, necesitas configurar tus credenciales de API:</p>
                    <ol>
                        <li>Crea una cuenta en <a href="https://app.alpaca.markets" target="_blank">Alpaca Markets</a></li>
                        <li>Obtén tus credenciales de API (key y secret)</li>
                        <li>Configura las credenciales en la sección de configuración</li>
                    </ol>
                    <a href="/alpaca/settings" class="btn btn-primary mt-2">
                        <i class="fas fa-cog"></i> Configurar API
                    </a>
                </div>
            `);
        }
    });
    
    function setupButtonHandlers() {
        // Manejar botones de posiciones e historial
        $('#btnPositions').click(function() {
            $('#resultsTitle').text('Tus Posiciones');
            $('#resultsContent').html(`
                <div class="text-center mb-3">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            `);
            $('#apiResults').show();
            
            // Crear un iframe oculto para recibir la respuesta
            const iframeId = 'positionsFrame_' + new Date().getTime();
            const $iframe = $('<iframe>', {
                name: iframeId,
                id: iframeId,
                style: 'display:none'
            }).appendTo('body');
            
            // Cargar la URL en el iframe
            $iframe.attr('src', '/alpaca/get_positions');
            
            // Manejar la respuesta cuando el iframe cargue
            $iframe.on('load', function() {
                try {
                    // Intentar obtener la respuesta JSON del iframe
                    const iframeContent = $iframe.contents().find('body').text();
                    const response = JSON.parse(iframeContent);
                    
                    if (response.success && response.positions) {
                        if (response.positions.length === 0) {
                            // No hay posiciones
                            $('#resultsContent').html(`
                                <div class="alert alert-info">
                                    <h5>No tienes posiciones abiertas</h5>
                                    <p>Actualmente no tienes ninguna posición abierta en tu cuenta de Alpaca.</p>
                                </div>
                            `);
                        } else {
                            // Mostrar las posiciones
                            let tableRows = '';
                            let totalValue = 0;
                            
                            for (const position of response.positions) {
                                const marketValue = parseFloat(position.market_value);
                                const unrealizedPL = parseFloat(position.unrealized_pl);
                                const unrealizedPLPerc = parseFloat(position.unrealized_plpc) * 100;
                                totalValue += marketValue;
                                
                                tableRows += `
                                    <tr>
                                        <td>${position.symbol}</td>
                                        <td>${parseInt(position.qty)}</td>
                                        <td>${marketValue.toFixed(2)}</td>
                                        <td class="${unrealizedPL >= 0 ? 'text-success' : 'text-danger'}">
                                            ${unrealizedPL >= 0 ? '+' : ''}${unrealizedPL.toFixed(2)} (${unrealizedPLPerc.toFixed(2)}%)
                                        </td>
                                    </tr>
                                `;
                            }
                            
                            $('#resultsContent').html(`
                                <div class="alert alert-info mb-3">
                                    <strong>Valor total de posiciones:</strong> ${totalValue.toFixed(2)}
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Símbolo</th>
                                                <th>Cantidad</th>
                                                <th>Valor Actual</th>
                                                <th>P&L</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-muted mt-2"><small>Datos actualizados: ${new Date().toLocaleString()}</small></p>
                            `);
                        }
                    } else {
                        // Mostrar error
                        $('#resultsContent').html(`
                            <div class="alert alert-danger">
                                <h5>Error al obtener posiciones</h5>
                                <p>${response.message || 'Error desconocido'}</p>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" id="retryPositions">Intentar Nuevamente</button>
                            </div>
                        `);
                        
                        $('#retryPositions').click(function() {
                            $('#btnPositions').click();
                        });
                    }
                } catch (e) {
                    // Error al procesar la respuesta
                    $('#resultsContent').html(`
                        <div class="alert alert-danger">
                            <h5>Error de comunicación</h5>
                            <p>No se pudo procesar la respuesta del servidor.</p>
                            <p><strong>Error:</strong> ${e.message}</p>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" id="retryPositions">Intentar Nuevamente</button>
                        </div>
                    `);
                    
                    $('#retryPositions').click(function() {
                        $('#btnPositions').click();
                    });
                }
                
                // Eliminar el iframe después de usarlo
                setTimeout(function() {
                    $iframe.remove();
                }, 1000);
            });
        });
        
        $('#btnHistory').click(function() {
            $('#resultsTitle').text('Historial de Órdenes');
            $('#resultsContent').html(`
                <div class="text-center mb-3">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            `);
            $('#apiResults').show();
            
            // Crear un iframe oculto para recibir la respuesta
            const iframeId = 'historyFrame_' + new Date().getTime();
            const $iframe = $('<iframe>', {
                name: iframeId,
                id: iframeId,
                style: 'display:none'
            }).appendTo('body');
            
            // Cargar la URL en el iframe
            $iframe.attr('src', '/alpaca/get_order_history');
            
            // Manejar la respuesta cuando el iframe cargue
            $iframe.on('load', function() {
                try {
                    // Intentar obtener la respuesta JSON del iframe
                    const iframeContent = $iframe.contents().find('body').text();
                    const response = JSON.parse(iframeContent);
                    
                    if (response.success && response.orders) {
                        if (response.orders.length === 0) {
                            // No hay órdenes
                            $('#resultsContent').html(`
                                <div class="alert alert-info">
                                    <h5>No hay órdenes recientes</h5>
                                    <p>No se encontraron órdenes recientes en tu cuenta de Alpaca.</p>
                                </div>
                            `);
                        } else {
                            // Mostrar las órdenes
                            let tableRows = '';
                            
                            for (const order of response.orders) {
                                const createdAt = new Date(order.created_at).toLocaleString();
                                const side = order.side === 'buy' ? 'Compra' : 'Venta';
                                const qty = order.qty;
                                const symbol = order.symbol;
                                const type = order.type;
                                const status = order.status;
                                
                                let statusBadge = '';
                                switch (status) {
                                    case 'filled':
                                        statusBadge = '<span class="badge bg-success">Completada</span>';
                                        break;
                                    case 'partially_filled':
                                        statusBadge = '<span class="badge bg-info">Parcialmente completada</span>';
                                        break;
                                    case 'canceled':
                                        statusBadge = '<span class="badge bg-danger">Cancelada</span>';
                                        break;
                                    case 'pending_new':
                                    case 'accepted':
                                    case 'new':
                                        statusBadge = '<span class="badge bg-warning">Pendiente</span>';
                                        break;
                                    default:
                                        statusBadge = '<span class="badge bg-secondary">' + status + '</span>';
                                }
                                
                                tableRows += `
                                    <tr>
                                        <td>${createdAt}</td>
                                        <td>${symbol}</td>
                                        <td>${side}</td>
                                        <td>${qty}</td>
                                        <td>${type}</td>
                                        <td>${statusBadge}</td>
                                    </tr>
                                `;
                            }
                            
                            $('#resultsContent').html(`
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Símbolo</th>
                                                <th>Tipo</th>
                                                <th>Cantidad</th>
                                                <th>Orden</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-muted mt-2"><small>Datos actualizados: ${new Date().toLocaleString()}</small></p>
                            `);
                        }
                    } else {
                        // Mostrar error
                        $('#resultsContent').html(`
                            <div class="alert alert-danger">
                                <h5>Error al obtener historial</h5>
                                <p>${response.message || 'Error desconocido'}</p>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" id="retryHistory">Intentar Nuevamente</button>
                            </div>
                        `);
                        
                        $('#retryHistory').click(function() {
                            $('#btnHistory').click();
                        });
                    }
                } catch (e) {
                    // Error al procesar la respuesta
                    $('#resultsContent').html(`
                        <div class="alert alert-danger">
                            <h5>Error de comunicación</h5>
                            <p>No se pudo procesar la respuesta del servidor.</p>
                            <p><strong>Error:</strong> ${e.message}</p>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" id="retryHistory">Intentar Nuevamente</button>
                        </div>
                    `);
                    
                    $('#retryHistory').click(function() {
                        $('#btnHistory').click();
                    });
                }
                
                // Eliminar el iframe después de usarlo
                setTimeout(function() {
                    $iframe.remove();
                }, 1000);
            });
        });
        
        $('#btnOrders').click(function() {
            $('#resultsTitle').text('Nueva Orden');
            $('#resultsContent').html(`
                <form id="orderForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="symbol" class="form-label">Símbolo</label>
                            <input type="text" class="form-control" id="symbol" placeholder="Ej: AAPL" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="orderType" class="form-label">Tipo de Orden</label>
                            <select class="form-control" id="orderType" required>
                                <option value="market">Market</option>
                                <option value="limit">Limit</option>
                                <option value="stop">Stop</option>
                                <option value="stop_limit">Stop Limit</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="side" class="form-label">Dirección</label>
                            <select class="form-control" id="side" required>
                                <option value="buy">Compra</option>
                                <option value="sell">Venta</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="qty" class="form-label">Cantidad</label>
                            <input type="number" class="form-control" id="qty" min="1" value="1" required>
                        </div>
                    </div>
                    
                    <div class="row" id="limitPriceRow" style="display:none;">
                        <div class="col-md-6 mb-3">
                            <label for="limitPrice" class="form-label">Precio Límite</label>
                            <input type="number" class="form-control" id="limitPrice" step="0.01">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="submit" class="btn btn-success">Enviar Orden</button>
                        <button type="button" class="btn btn-secondary" id="cancelOrder">Cancelar</button>
                    </div>
                </form>
            `);
            $('#apiResults').show();
            
            // Mostrar/ocultar precio límite según el tipo de orden
            $('#orderType').change(function() {
                const orderType = $(this).val();
                if (orderType === 'limit' || orderType === 'stop_limit') {
                    $('#limitPriceRow').show();
                } else {
                    $('#limitPriceRow').hide();
                }
            });
            
            // Manejar formulario de orden
            $('#orderForm').submit(function(e) {
                e.preventDefault();
                
                const formData = {
                    symbol: $('#symbol').val(),
                    orderType: $('#orderType').val(),
                    side: $('#side').val(),
                    qty: $('#qty').val()
                };
                
                // Añadir precio límite si es necesario
                if (formData.orderType === 'limit' || formData.orderType === 'stop_limit') {
                    formData.limitPrice = $('#limitPrice').val();
                }
                
                // Mostrar estado de procesamiento
                $('#resultsContent').html(`
                    <div class="text-center mb-3">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Procesando orden...</span>
                        </div>
                        <p>Enviando orden a Alpaca...</p>
                    </div>
                `);
                
                // Construir URL con parámetros
                let url = '/alpaca/create_order?';
                for (const [key, value] of Object.entries(formData)) {
                    url += `${key}=${encodeURIComponent(value)}&`;
                }
                
                // Eliminar el último &
                url = url.slice(0, -1);
                
                // Crear un iframe oculto para recibir la respuesta
                const iframeId = 'submitFrame_' + new Date().getTime();
                const $iframe = $('<iframe>', {
                    name: iframeId,
                    id: iframeId,
                    style: 'display:none'
                }).appendTo('body');
                
                // Cargar la URL en el iframe
                $iframe.attr('src', url);
                
                // Manejar la respuesta cuando el iframe cargue
                $iframe.on('load', function() {
                    try {
                        // Intentar obtener la respuesta JSON del iframe
                        const iframeContent = $iframe.contents().find('body').text();
                        const response = JSON.parse(iframeContent);
                        
                        if (response.success) {
                            // Mostrar confirmación de éxito
                            $('#resultsContent').html(`
                                <div class="alert alert-success">
                                    <h5>Orden enviada correctamente</h5>
                                    <p>La orden de ${formData.side === 'buy' ? 'compra' : 'venta'} de ${formData.qty} ${formData.symbol} ha sido enviada con éxito a Alpaca.</p>
                                    <p><strong>ID de Orden:</strong> ${response.order?.id || 'N/A'}</p>
                                    <p><strong>Estado:</strong> <span class="badge bg-warning">${response.order?.status || 'Pendiente'}</span></p>
                                    <p><strong>Tipo:</strong> ${response.order?.type || formData.orderType}</p>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" id="newOrder">Nueva Orden</button>
                                    <button class="btn btn-info" id="viewPositionsBtn">Ver Posiciones</button>
                                </div>
                            `);
                            
                            // Añadir eventos para los botones
                            $('#newOrder').click(function() {
                                $('#btnOrders').click();
                            });
                            
                            $('#viewPositionsBtn').click(function() {
                                $('#btnPositions').click();
                            });
                        } else {
                            // Mostrar error
                            $('#resultsContent').html(`
                                <div class="alert alert-danger">
                                    <h5>Error al enviar la orden</h5>
                                    <p>${response.message || 'Error desconocido'}</p>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" id="retryOrder">Intentar Nuevamente</button>
                                </div>
                            `);
                            
                            $('#retryOrder').click(function() {
                                $('#orderForm').submit();
                            });
                        }
                    } catch (e) {
                        // Error al procesar la respuesta
                        $('#resultsContent').html(`
                            <div class="alert alert-danger">
                            <h5>Error de comunicación</h5>
                            <p>No se pudo procesar la respuesta del servidor.</p>
                            <p><strong>Error:</strong> ${e.message}</p>
                            </div>
                            <div class="mt-3">
                            <button class="btn btn-primary" id="retryOrder">Intentar Nuevamente</button>
                            </div>
                        `);
                        
                        $('#retryOrder').click(function() {
                            $('#orderForm').submit();
                        });
                    }
                    
                    // Eliminar el iframe después de usarlo
                    setTimeout(function() {
                        $iframe.remove();
                    }, 1000);
                });
            });
            
            $('#cancelOrder').click(function() {
                $('#apiResults').hide();
            });
        });
    }
</script>
{% endblock %}